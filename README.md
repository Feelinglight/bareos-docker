# Описание

В Dockerfile описаны несколько образов (multistage build):

- bareos director (dir)
- bareos storage daemon (sd)
- bareos file daemon (fd)
- bareos webui


Примеры запуска всех образов есть в **example/**.


## Переменные окружения

При первом запуске или обновлении нужно обновлять базу данных. Для этого используются переменные
окружения:

- ``DB_INIT=true`` - запустить инициализацию БД при старте контейнера. Нужно запустить 1 раз при
  первом запуске bareos.
- ``DB_UPDATE=true`` - запуск миграцию БД при старте контейнера. Нужно запускать при каждом
  обновлении bareos.
- ``BAREOS__DB_HOST`` - адрес БД.
- ``POSTGRES_ADMIN_USER`` - имя админа postgres.
- ``POSTGRES_ADMIN_PASSWORD`` - пароль админа postgres.

Все остальные переменные окружения кастомные, см. раздел **make_bareos_config.sh**.


## make_bareos_config.sh

Bareos хранит все пароли в файлах конфигурации.

Скрипт **make_bareos_config.sh** нужен, чтобы задавать пароли и другие настройки через переменные
окружения. Скрипт удаляет содержимое папки **/etc/bareos** и копирует в нее содержимое
**/etc_bareos**.

После этого все переменные окружения, начинающиеся с ``BAREOS__`` подставляются во все файлы
в **/etc/bareos** (обходится рекурсивно).

В файлах имена переменных должны быть обрамлены двойными фигурными скобками.

Переменные окружения задаются динамически (т. е. не определены при сборке образа), потому что
их количество может быть произвольным. Например, для каждого нового клиента в файлах конфигурации
требуется новый пароль.

Пример:

Есть файл

```nginx
Catalog {
  Name = BareosCatalog
  DB Address = "{{BAREOS__DB_HOST}}"

  # ...
}
```

Если запустить образ с переменной окружения ``BAREOS__DB_HOST=bareos-db-host``, то
содержимое файла перед запуском bareos будет:

```nginx
Catalog {
  Name = BareosCatalog
  DB Address = "bareos-db-host"

  # ...
}
```


## Сборка образов

Во все образы добавляются:

- репозитории bareos
- скрипт **make_bareos_config.sh**
- entrypoint (у каждого образа свой)

Все entrypoint-ы запускают скрипт **make_bareos_config.sh**.
Webui, кроме скрипта, запускает **php-fpm**.

CMD у всех образов, кроме webui - соответствующий демон bareos (bareos-dir, bareos-sd, bareos-fd).
CMD У webui - nginx.


### Запуск сборки

Для сборки используется скрипт **build.sh**, в котором нужно указать переменные

- ``BAREOS_VERSION="24.0.5~pre32.7c5f79a1e"`` - версия пакетов bareos. Используется только для тэга
  образов
- ``DISTRO="xUbuntu_24.04"`` - дистрибутив, под который собраны пакеты bareos. Значение должно быть
  равно имени одной из папок на https://download.bareos.org/current/

